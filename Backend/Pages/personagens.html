<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personagens</title>
  <link rel="stylesheet" href="css/personagens.css" />
  <script src="https://unpkg.com/lucide@latest"></script>

</head>

<body>
  <div class="tela-personagens">
    <h1>Personagens</h1>
    <hr />
    <div class="lista-personagens" id="lista-personagens">
      <!-- Lista será preenchida pelo JavaScript -->
    </div>

    <a href="/novo-personagem" id="novo-personagem" class="novo-personagem">Novo Personagem</a>

  </div>

  <div class="navbar">
    <button class="active" data-aba="personagem" onclick="irPara('/personagens')">
      <i data-lucide="user"></i>
      <span>Personagem</span>
    </button>
    <button data-aba="atributos" onclick="irPara('/atributos')">
      <i data-lucide="list"></i>
      <span>Atributos</span>
    </button>
    <button data-aba="habilidades" onclick="irPara('/habilidades')">
      <i data-lucide="star"></i>
      <span>Habilidades</span>
    </button>
    <button data-aba="magias" onclick="irPara('/magias')">
      <i data-lucide="zap"></i>
      <span>Magias</span>
    </button>
    <button data-aba="inventario" onclick="irPara('/inventario')">
      <i data-lucide="briefcase"></i>
      <span>Inventário</span>
    </button>
    <button data-aba="jogador" onclick="irPara('/jogador')">
      <i data-lucide="user-circle"></i>
      <span>Jogador</span>
    </button>
  </div>

  <script>
    function irPara(pagina) {
      window.location.href = pagina;
    }
    lucide.createIcons();

    const token = localStorage.getItem("token");

    // Verifica se o usuário está logado
    if (!token) {
      window.location.href = "index.html"; // Redireciona para login
    } else {
      fetch("https://dndapp-0f3t.onrender.com/profile", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.user) {
            console.log("Usuário logado:", data.user.username);
            // CARREGAR PERSONAGENS AQUI
            carregarPersonagens();
          } else {
            window.location.href = "index.html";
          }
        })
        .catch(() => {
          window.location.href = "index.html";
        });
    }

    // Função para carregar e mostrar personagens
    async function carregarPersonagens() {
      try {
        const response = await fetch("https://dndapp-0f3t.onrender.com/characters", {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const personagens = data.characters;
          
          const lista = document.getElementById("lista-personagens");
          
          if (personagens.length === 0) {
            lista.innerHTML = "<p>Você ainda não criou nenhum personagem.</p>";
          } else {
            lista.innerHTML = "";
            personagens.forEach(personagem => {
              const item = document.createElement("li");
              item.innerHTML = `
                <strong>${personagem.nome}</strong><br>
                ${personagem.classe_nivel || 'Classe não definida'} - ${personagem.raca || 'Raça não definida'}<br>
                <small>Vida: ${personagem.pontos_vida_atual || 0}/${personagem.pontos_vida_max || 0}</small>
              `;
              item.style.cursor = "pointer";
              item.addEventListener("click", () => selecionarPersonagem(personagem.id));
              lista.appendChild(item);
            });
          }
        } else {
          console.error("Erro ao carregar personagens");
        }
      } catch (error) {
        console.error("Erro:", error);
      }
    }

    function selecionarPersonagem(characterId) {
      // Definir este personagem como ativo
      localStorage.setItem('selectedCharacterId', characterId);
      
      // Ir para a página de visualização do personagem
      irPara('/visualizar-personagem');
    }

    // Função de navegação entre abas
    function irPara(pagina) {
      window.location.href = pagina;
    }

    // Ícones do Lucide
    lucide.createIcons();

    // Logout
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }
  </script>
</body>

</html>
